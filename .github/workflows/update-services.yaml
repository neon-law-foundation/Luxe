---
name: Update ECS Services

on:
  schedule:
    - cron: '0 13 * * *'  # 5am PST (1pm UTC)
  workflow_dispatch:  # Allow manual trigger

jobs:
  update-services:
    runs-on: ubuntu-latest

    steps:
      - name: Configure AWS CLI
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.SAGEBRUSH_AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.SAGEBRUSH_AWS_SECRET_ACCESS_KEY }}
          aws-region: us-west-2

      - name: Update ECS Services
        run: |
          set +x  # Disable bash output

          echo "üîÑ Starting ECS service updates..."

          # List all clusters
          clusters=$(aws ecs list-clusters --region us-west-2 --query 'clusterArns[]' --output text)

          for cluster_arn in $clusters; do
            cluster_name=$(basename $cluster_arn)
            echo "üìã Processing cluster: $cluster_name"

            # List services in cluster
            services=$(aws ecs list-services --cluster $cluster_name --region us-west-2 --query 'serviceArns[]' --output text)

            for service_arn in $services; do
              service_name=$(basename $service_arn)

              # Only update Bazaar and Destined services
              if [[ "$service_name" == "Bazaar" || "$service_name" == "Destined" ]]; then
                echo "üîÑ Updating service: $service_name in cluster: $cluster_name"

                aws ecs update-service \
                  --cluster $cluster_name \
                  --service $service_name \
                  --force-new-deployment \
                  --region us-west-2 > /dev/null 2>&1

                if [ $? -eq 0 ]; then
                  echo "‚úÖ Successfully triggered update for $service_name"
                else
                  echo "‚ùå Failed to update $service_name"
                fi

                # Wait for service to stabilize
                echo "‚è≥ Waiting for $service_name to stabilize..."
                aws ecs wait services-stable \
                  --cluster $cluster_name \
                  --services $service_name \
                  --region us-west-2 > /dev/null 2>&1

                if [ $? -eq 0 ]; then
                  echo "‚úÖ Service $service_name is stable"
                else
                  echo "‚ö†Ô∏è Service $service_name may still be updating"
                fi
              fi
            done
          done

          set -x  # Re-enable bash output
          echo "üéâ ECS service update process completed"
